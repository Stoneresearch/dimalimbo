<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DIMA LIMBO VOL.1</title>
    <style>
      html, body { height: 100%; margin: 0; background: #0a0b10; color: #e6e6e6; font-family: system-ui, sans-serif; }
      #root { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; }
      /* Ensure Ebiten canvas fills the viewport while preserving pixel look */
      #ebiten-canvas { width: 100vw; height: 100vh; max-width: 100%; max-height: 100%; }
      canvas { image-rendering: pixelated; }
      .loading { opacity: .8; font-size: 14px; }
      a { color: #8be9fd; }
    </style>
  </head>
  <body>
    <div id="root">
      <div class="loading">Loading DIMA LIMBO VOL.1...</div>
    </div>
    <script src="wasm_exec.js"></script>
    <script>
      (async () => {
        try {
          if (!('WebAssembly' in window)) {
            throw new Error('WebAssembly not supported in this browser');
          }
          // Polyfill instantiateStreaming if server doesn't set correct MIME type
          if (!WebAssembly.instantiateStreaming) {
            WebAssembly.instantiateStreaming = async (resp, importObject) => {
              const source = await (await resp).arrayBuffer();
              return await WebAssembly.instantiate(source, importObject);
            };
          }
          const go = new Go();
          const wasmUrl = 'dimalimbo.wasm';
          // HEAD first to detect 404 early and provide better error
          const head = await fetch(wasmUrl, { method: 'HEAD' });
          if (!head.ok) {
            throw new Error(`WASM not found (${head.status}). Ensure ${wasmUrl} is deployed alongside index.html`);
          }
          const result = await WebAssembly.instantiateStreaming(fetch(wasmUrl), go.importObject).catch(async e => {
            // Fallback to arrayBuffer path (e.g., wrong MIME type on GH Pages)
            console.warn('instantiateStreaming failed, retrying with arrayBuffer', e);
            const res = await fetch(wasmUrl);
            if (!res.ok) throw new Error(`Failed fetching WASM: ${res.status}`);
            const bytes = await res.arrayBuffer();
            return await WebAssembly.instantiate(bytes, go.importObject);
          });
          await go.run(result.instance);
        } catch (err) {
          const msg = `WebAssembly failed to load: ${String(err)}<br/>`+
            `If this is GitHub Pages, verify that index.html, wasm_exec.js, and dimalimbo.wasm are in the same folder.`;
          document.getElementById('root').innerHTML = `<div class="loading">${msg}</div>`;
          console.error(err);
        }
      })();
    </script>
  </body>
  </html>


